<script setup lang="ts">
import { ref, onMounted } from "vue";
import { supabase } from "../supabase"; // file config k·∫øt n·ªëi Supabase

const patients = ref<any[]>([]);
const loading = ref(true);
const error = ref<string | null>(null);

// H√†m load danh s√°ch t√°i kh√°m h√¥m nay
const loadPatients = async () => {
  loading.value = true;
  error.value = null;

  try {
    const today = new Date().toISOString().split("T")[0]; // YYYY-MM-DD

    const { data, error: supabaseError } = await supabase
      .from("khambenh")
      .select(`
        benhnhan_id,
        benhnhan ( ho_ten, ngay_sinh ),
        ngay_kham,
        chan_doan,
        so_ngay_toa
      `)
      .eq("ngay_hen_tai_kham", today);

    if (supabaseError) throw supabaseError;
    patients.value = data || [];
  } catch (err: any) {
    error.value = err.message || "L·ªói khi t·∫£i d·ªØ li·ªáu";
  } finally {
    loading.value = false;
  }
};

onMounted(loadPatients);
</script>

<template>
  <div class="p-4">
    <h2 class="text-lg font-bold mb-3">üìã Danh s√°ch t√°i kh√°m h√¥m nay</h2>

    <div v-if="loading">‚è≥ ƒêang t·∫£i d·ªØ li·ªáu...</div>
    <div v-else-if="error" class="text-red-500">‚ö†Ô∏è {{ error }}</div>
    <table v-else class="table-auto border-collapse border border-gray-400 w-full">
      <thead>
        <tr class="bg-gray-200">
          <th class="border border-gray-400 px-2 py-1">M√£ BN</th>
          <th class="border border-gray-400 px-2 py-1">H·ªç t√™n</th>
          <th class="border border-gray-400 px-2 py-1">Ng√†y sinh</th>
          <th class="border border-gray-400 px-2 py-1">Ng√†y kh√°m</th>
          <th class="border border-gray-400 px-2 py-1">Ch·∫©n ƒëo√°n</th>
          <th class="border border-gray-400 px-2 py-1">S·ªë ng√†y toa</th>
        </tr>
      </thead>
      <tbody>
        <tr v-for="(p, i) in patients" :key="i">
          <td class="border border-gray-400 px-2 py-1">{{ p.benhnhan_id }}</td>
          <td class="border border-gray-400 px-2 py-1">{{ p.benhnhan.ho_ten }}</td>
          <td class="border border-gray-400 px-2 py-1">{{ p.benhnhan.ngay_sinh }}</td>
          <td class="border border-gray-400 px-2 py-1">{{ p.ngay_kham }}</td>
          <td class="border border-gray-400 px-2 py-1">{{ p.chan_doan }}</td>
          <td class="border border-gray-400 px-2 py-1">{{ p.so_ngay_toa }}</td>
        </tr>
      </tbody>
    </table>

    <div v-if="!loading && patients.length === 0" class="mt-2 text-gray-500">
      Kh√¥ng c√≥ b·ªánh nh√¢n n√†o h·∫πn t√°i kh√°m h√¥m nay.
    </div>
  </div>
</template>
